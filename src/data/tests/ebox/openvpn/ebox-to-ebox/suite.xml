<suite>
    <name>eBox to eBox Test Suite</name>
    <desc>Contains a set of tests to ensure
    that ebox OpenVPN module works ok.
    </desc>
    
    <scenario>ebox/openvpn/ebox-to-ebox.xml</scenario>

    <test type="selenium">
        <name>EnableModulesServer</name>
        <desc>
        Enable network, firewall and openvpn modules.
        </desc>

        <host>ebox-server</host>
        <dir>enable-modules</dir>
    </test>        

    <test type="selenium">
        <name>ConfigNetworkServer</name>
        <desc>
        Sets the interface as external.
        </desc>

        <host>ebox-server</host>
        <dir>config-net</dir>
    </test>        

    <test type="selenium">
        <name>RemoveGatewayServer</name>
        <desc>Remote the default gateway on the anste's communication
        interface.
        </desc>

        <host>ebox-server</host>
        <dir>remove-default-gw</dir>
    </test>        

    <test type="selenium">
        <name>AddGatewayServer</name>
        <desc>Adds the scenario routers as gateways</desc>

        <host>ebox-server</host>
        <dir>add-gateway</dir>
        <env>GATEWAY=192.168.3.2</env>
    </test>

    <test type="selenium">
        <name>ConfigCA</name>
        <desc>
        Config CA.
        </desc>

        <host>ebox-server</host>
        <dir>config-ca</dir>
        <env>ADVERTISED_NETWORK=192.168.20.0</env>
    </test>

    <test type="selenium">
        <name>EnableModulesClient</name>
        <desc>
        Enable network, firewall and openvpn modules.
        </desc>

        <host>ebox-client</host>
        <dir>enable-modules</dir>
    </test>        

    <test type="selenium">
        <name>ConfigNetworkClient</name>
        <desc>
        Sets the interface as external.
        </desc>

        <host>ebox-client</host>
        <dir>config-net</dir>
    </test>        

    <test type="selenium">
        <name>RemoveGatewayClient</name>
        <desc>Remote the default gateway on the anste's communication
        interface.
        </desc>

        <host>ebox-client</host>
        <dir>remove-default-gw</dir>
    </test>        

    <test type="selenium">
        <name>AddGatewayClient</name>
        <desc>Adds the scenario routers as gateways</desc>

        <host>ebox-client</host>
        <dir>add-gateway</dir>
        <env>GATEWAY=192.168.5.2</env>
    </test>

    <test>
        <name>SetupRouterA</name>
        <desc>
        Setup redirection to eBox machine.
        </desc>

        <host>router-a</host>
        <dir>setup-router</dir>
        <env>DEST=192.168.3.1</env>
    </test>

    <test>
        <name>SetupRouterB</name>
        <desc>
        Setup redirection to eBox machine.
        </desc>

        <host>router-b</host>
        <dir>setup-router</dir>
        <env>DEST=192.168.5.1</env>
    </test>

    <test>
        <name>GenerateBundle</name>
        <desc>
        Generate OpenVPN bundle on eBox server.
        </desc>

        <host>ebox-server</host>
        <dir>generate-bundle</dir>
        <env>TYPE=EBoxToEBox CLIENT=client ROUTER=192.168.4.2</env>
    </test>

    <test>
        <name>DownloadBundle</name>
        <desc>
        Download OpenVPN bundle on ebox client.
        </desc>

        <host>ebox-client</host>
        <dir>download-bundle</dir>
        <env>HOST=192.168.4.2 CLIENT=client</env>
    </test>

    <test>
        <name>AddClientFromBundle</name>
        <desc>
        Add VPN client from bundle using eBox API.
        </desc>

        <host>ebox-client</host>
        <dir>add-client-from-bundle</dir>
        <env>CLIENT=client</env>
    </test>

    <test type="selenium">
        <name>CheckClientAdded</name>
        <desc>
        Check if client added and save changes.
        Also allow traffic from internal.
        </desc>

        <host>ebox-client</host>
        <dir>check-client-added</dir>
    </test>

    <test>
        <name>StartServer</name>
        <desc>
        Start server on one of the internal clients.
        </desc>
        
        <host>internal-a</host>
        <dir>start-server</dir>
    </test>
    
    <test>
        <name>TestVPNFail</name>
        <desc>
        Connect to the VPN and try to access
        the other machine before enabling
        ebox to ebox connection.
        </desc>
        
        <host>internal-b</host>
        <dir>test-client</dir>
        <env>HOST=192.168.20.2</env>

        <assert>failed</assert>
    </test>

    <test type="selenium">
        <name>AllowEboxToEbox</name>
        <desc>
        Allow ebox to ebox tunnels.
        Also allow traffic from internal.
        </desc>

        <host>ebox-server</host>
        <dir>allow-ebox-to-ebox</dir>
    </test>

    <test>
        <name>TestVPN</name>
        <desc>
        Connect to the VPN and try to access
        the other machine after enabling
        client to client connection.
        </desc>
        
        <host>internal-b</host>
        <dir>test-client</dir>
        <env>HOST=192.168.20.2</env>
    </test>

</suite>
